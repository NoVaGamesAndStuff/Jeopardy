<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Room</title>
    <style>
        table { border-collapse: collapse; } 
        td, th { border: 1px solid black; padding: 8px; }
        div.zoomedCell { 
            background-color: blue; 
            text-shadow: 2px 2px 2px black;
            color: white;
            vertical-align: middle;
            text-align: center;
            font-size: 36px;
            padding: 40px; 
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
        }
        table.jeopardyboard {
            width: 1000px;
            height: 600px;
            float: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        td.boardCell {
            background-color: blue;
            text-shadow: 2px 2px 2px black;
            color: white;
            vertical-align: top;
            text-align: center;
        }
        .disabled {
            pointer-events: none;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Container for initial game behavior: displaying table of current players, room code, who the host is, and starting the game (host only) -->
    <div id="initialViewContainer" style="display: block;">
        <h1>Jeopardy</h1>

        <div id="roomInfoContainer" style="display: none;">
            <p id="roomCode" style="font-weight: bold;"></p>
            <p id="hostName" style="font-weight: bold;"></p>
            <button id="startGameButton" style="display: none;" onclick="startGame()">Start Game</button>
        </div>
    
        <br>
    
        <table id="playerTable">
            <tr>
                <th>Display Name</th>
                <th>Score</th>
            </tr>
        </table>
    </div>

    <!-- Container for all PC behavior: displaying the board (single, double, final jeopardy) -->
    <div id="boardContainer" style="display: none;"></div>

    <!-- Container for all Host behavior: displaying question info, unlocking questions, correct/incorrect answers, etc. -->
    <div id="hostViewContainer" style="display: none;">
        <div id="waitingForQuestionSelect" style="display: block;">Waiting for the player to select a question...</div>
        <div id="questionContainer" style="display: none;"></div>
        <div id="answerContainer" style="display: none;"></div>
		<div id="wrongAndSkipButtons" style="display: none;">
            <button id="wrongButton" style="display: block;" onclick="wrongQuestion()">Wrong Answer</button>
            <button id="skipButton" style="display: block;" onclick="skipQuestion()">Skip Question</button>
        </div>
		
        <div id="buzzedPlayerInfo" style="display: none;"></div>
        <br><br><button id="unlockQuestion" onclick="unlockQuestion()" style="display: none;">Unlock Question</button>
        <div id="wrongAndSkipButtons" style="display: none;">
            <button id="wrongButton" style="display: block;" onclick="wrongQuestion()">Wrong Answer</button>
            <button id="skipButton" style="display: block;" onclick="skipQuestion()">Skip Question</button>
        </div>
        
    </div>

    <!-- Container for all player behavior: buzzer, displaying score, etc. -->
    <div id="playerViewContainer" style="display: none;">
        <div id="playerNameContainer" style="font-weight: bold;"></div><br><br>
        <button id="buzzer" onclick="buzz()" disabled>
            <img src="/assets/buzzer_enabled.jpg" alt="enabled buzzer">
        </button>
    </div>
    <!-- <div id="wagerContainer" style="display: block;"> -->
        <!-- <button id="setWagerButton"onclick="setWager()">Set Wager</button> -->
        <!-- <input id="wager_input" name="wager_input" type="text" /> -->
    <!-- </div> -->

    <!-- Container for end game behavior: displaying the winner -->
    <div id="gameEndViewContainer" style="display: none;"></div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io();
        const roomKey = window.location.pathname.split('/').pop();

        var socketId;
        socket.on('connect', () => {
            console.log('Socket connection was made with ID: ' + socket.id);
            socketId = socket.id;
        });

        let wagerValue = 0;
        let board = null;
        let currDispName = localStorage.getItem('currentDisplayName');

        let initialViewContainer = document.getElementById('initialViewContainer');
        let boardContainer = document.getElementById('boardContainer');
        let hostViewContainer = document.getElementById('hostViewContainer');
        let playerViewContainer = document.getElementById('playerViewContainer');
        let gameEndViewContainer = document.getElementById('gameEndViewContainer');

        let doubleJeopardy = false;
        let finalJeopardy = false;
        let singleJeopardyCells = 30;
        let doubleJeopardyCells = 60; 
        let selectedCells = new Set();

        socket.emit('getRoom', { roomKey, currDispName });

        socket.on('getRoomInfo', ({ room, isHost }) => {
            console.log('Got room info:', room);
            updatePlayerTable(room.players);

            if (room.host) {
                const roomCodeContainer = document.getElementById('roomInfoContainer');
                const roomCodeElement = document.getElementById('roomCode');
                const hostNameElement = document.getElementById('hostName');
                roomCodeElement.textContent = `Room Code: ${room.key}`;
                hostNameElement.textContent = `The host is ${room.host.name}`;
                roomCodeContainer.style.display = 'block';
            }

            if (isHost) {
                const startGameButton = document.getElementById('startGameButton');
                startGameButton.style.display = 'block';
            }

            board = room.board;
        });

        function updatePlayerTable(players) {
            console.log('Received updated player data:', players);
            const playerTable = document.getElementById('playerTable');

            while (playerTable.rows.length > 1) {
                playerTable.deleteRow(1);
            }

            players.forEach(player => {
                console.log(player);
                const row = playerTable.insertRow();
                const nameCell = row.insertCell(0);
                const scoreCell = row.insertCell(1);
                nameCell.textContent = player.name;
                scoreCell.textContent = player.score;
            });
        }

        function startGame() {
            console.log('Starting the game...');
            socket.emit('startGame', roomKey);
        }

        socket.on('gameStartView', ({ entityName, obj }) => {
            if (entityName == 'host') {
                initialViewContainer.style.display = 'none';
                hostViewContainer.style.display = 'block';
            } else if (entityName == 'pc') {
                displayBoard(obj, doubleJeopardy, finalJeopardy);
                roomInfoContainer.style.display = 'none';
                boardContainer.style.display = 'block';
            } else if (entityName == 'player') {
                initialViewContainer.style.display = 'none';
                playerViewContainer.style.display = 'block';
                const playerNameContainer = document.getElementById('playerNameContainer');
                playerNameContainer.textContent = currDispName;
            } else {
                console.log('Unrecognized entity.');
            }
        });

        socket.on('questionSelected', (questionInfo) => {
            document.getElementById('waitingForQuestionSelect').style.display = 'none';
            let questionContainer = document.getElementById('questionContainer');
            questionContainer.style.display = 'block';
            questionContainer.textContent = 'Clue: ' + questionInfo.clue;

            let answerContainer = document.getElementById('answerContainer');
            answerContainer.style.display = 'block';
            answerContainer.textContent = 'Answer: ' + questionInfo.answer;

            let wrongAndSkipButtons = document.getElementById('wrongAndSkipButtons');
            wrongAndSkipButtons.style.display = 'block';
        });

        function displayZoomedCell(questionText) {
            let zoomedCell = document.createElement('div');
            zoomedCell.className = 'zoomedCell';
            zoomedCell.textContent = questionText;

            boardContainer.innerHTML = ''; 
            boardContainer.appendChild(zoomedCell);

            zoomedCell.addEventListener('click', function () {
                boardContainer.innerHTML = '';
                displayBoard(board, doubleJeopardy, finalJeopardy);
                revertHostView(); // TESTING
            });
        }

        function handleCellClick(event) {
            console.log("Cell clicked!");
            
            const clickedCell = event.target;

            if (!selectedCells.has(clickedCell.id)) { 
                console.log("Unclicked cell clicked!");
                const questionID = clickedCell.id;
                selectedCells.add(questionID); 

                let questionText = 'N/A'; 
                if (questionID.charAt(0) == 's') {
                    questionText = getQuestionText(board.Single, questionID);
                } else if (questionID.charAt(0) == 'd') {
                    questionText = getQuestionText(board.Double, questionID);
                } else if (questionID.charAt(0) == 'f') {
                    questionText = getQuestionText(board.Final, questionID);
                }

                clickedCell.style.backgroundColor = 'gray'; 
                clickedCell.removeEventListener('click', handleCellClick); 
                singleJeopardyCells--;
                doubleJeopardyCells--;

                if (singleJeopardyCells === 0) {
                    doubleJeopardy = true;
                }
                if (doubleJeopardyCells === 0){
                    doubleJeopardy = false;
                    finalJeopardy = true;
                }

                displayZoomedCell(questionText);
                socket.emit('selectQuestion', { roomKey, questionID });
            }
        }

        function displayBoard(board, doubleJeopardy, finalJeopardy) {
            while (boardContainer.firstChild) {
                boardContainer.removeChild(boardContainer.firstChild);
            }

            let jeopardyBoard = document.createElement('table');
            jeopardyBoard.className = 'jeopardyboard';

            if (finalJeopardy == false) {
                let currentValue = 0;
                for (let i = 0; i < 6; i++) {
                    let elements = [];
                    if (doubleJeopardy) {
                        if (i > 0) currentValue += 400;
                        console.log('Getting row elements for value ' + currentValue);
                        elements = retrieveBoardElements(i, board.Double, currentValue);
                    } else {
                        if (i > 0) currentValue += 200;
                        elements = retrieveBoardElements(i, board.Single, currentValue);
                    }

                    let row = document.createElement('tr');
    
                    for (let j = 0; j < elements.length; j++) {
                        let element = elements[j];
                        let cell = document.createElement('td');
                        cell.className = 'boardCell';
                        if (typeof element !== 'string') cell.id = element.id;
    
                        if (i === 0) {
                            cell.style.height = '40px';
                            cell.textContent = element;
                        } else {
                            cell.style.height = '100px';
                            cell.textContent = `$${element.value}`;
                            cell.addEventListener('click', handleCellClick);
                        }

                        if (selectedCells.has(element.id)) {
                            cell.removeEventListener('click', handleCellClick); 
                            cell.className += ' disabled';
                        }
    
                        row.appendChild(cell);
                    }

                    jeopardyBoard.appendChild(row);
                }
            } else {
                for (let i = 0; i < 2; i++) {
                    let elements = retrieveBoardElements(i, board.Final, -1);
                    let row = document.createElement('tr');

                    for (let j = 0; j < elements.length; j++) {
                        let element = elements[j];
                        let cell = document.createElement('td');
                        cell.className = 'boardCell';
                        if (typeof element !== 'string') cell.id = element.id;
    
                        if (i === 0) {
                            cell.style.height = '40px';
                            cell.textContent = element;
                        } else {
                            cell.style.height = '100px';
                            cell.textContent = 'Wager Value';
                            cell.addEventListener('click', handleCellClick);
                        }

                        if (selectedCells.has(element.id)) {
                            cell.removeEventListener('click', handleCellClick); 
                            cell.className += ' disabled';
                        }
    
                        row.appendChild(cell);
                    }

                    jeopardyBoard.appendChild(row);
                }
            }

            boardContainer.appendChild(jeopardyBoard);
        }

        function retrieveBoardElements(i, arr, value) {
            let elements = [];
            if (i == 0) {
                for (let k = 0; k < arr.length; k++) {
                    elements.push(arr[k].category);
                }
            } else {
                for (let k = 0; k < arr.length; k++) {
                    let category = arr[k];
                    for (let l = 0; l < category.clues.length; l++) {
                        if (value == -1 || category.clues[l].value == value) {
                            elements.push(category.clues[l]);
                        }
                    }
                }
            } 

            return elements;
        }

        function getQuestionText(arr, id) {
            let text = 'N/A';
            for (let i = 0; i < arr.length; i++) {
                let category = arr[i];
                for (let j = 0; j < category.clues.length; j++) {
                    if (category.clues[j].id == id) {
                        text = category.clues[j].clue;
                        break;
                    }
                }
            }

            return text;
        }

        function setWager(wager, gameState){
            if(singleJeopardy){
                if(currentPlayer.score < wager){
                    console.log("Your score must be greater than or equal to your wager.")
                }
                else if(currentPlayer.score < wager || wager <= 1000){
                    wagerValue = wager;
                }
                else if(currentPlayer.score > wager)
                {
                    wagerValue = wager;
                }
            }
            if(doubleJeopardy){
                if(currentPlayer.score < wager){
                        console.log("Your score must be greater than or equal to your wager.")
                    }
                    else if(currentPlayer.score < wager || wager <= 2000){
                        wagerValue = wager;
                    }
                    else if(currentPlayer.score > wager)
                    {
                        wagerValue = wager;
                    }
                }
            if(finalJeopardy){
                if(currentPlayer.score < wager){
                    console.log("Your score must be greater than or equal to your wager.")
                }
                else
                {
                    wagerValue = wager;
                }
            }
    
            console.log("Wager set");
    
        }

        function createBoard(rows, columns) {
            let board = [];

            for (let i = 0; i < rows; i++) {
                let row = [];

                for (let j = 0; j < columns; j++) {
                    row.push((i + j) % 2 === 0);
                }
                board.push(row);
            }
            return board;
        } 

        function revertHostView() {
            console.log('Resetting host view...');
            document.getElementById('waitingForQuestionSelect').style.display = 'block';
            document.getElementById('questionContainer').style.display = 'none';
            document.getElementById('questionContainer').style.display = 'none';
            document.getElementById('answerContainer').textContent = '';
            document.getElementById('answerContainer').textContent = '';
            document.getElementById('unlockQuestion').style.display = 'none';
        }

        function unlockQuestion() {
            const unlockQuestion = document.getElementById('unlockQuestion');
            unlockQuestion.style.display = 'none';
            const buzzedPlayerInfo = document.getElementById('buzzedPlayerInfo');
            buzzedPlayerInfo.style.display = 'none';
            buzzedPlayerInfo.textContent = '';
            socket.emit('unlockQuestion', roomKey);
        }

        function buzz() {
            console.log('This player buzzed! Socket ID: ' + socketId);
            socket.emit('lockQuestion', { roomKey, socketId });
        }

        socket.on('enableBuzzer', (playerName) => {
            const buzzer = document.getElementById('buzzer');
            buzzer.disabled = false;
        });

        socket.on('disableBuzzer', (playerName) => {
            const buzzer = document.getElementById('buzzer');
            buzzer.disabled = true;
        });

        socket.on('getBuzzedPlayerInfo', (currentPlayer) => {
            const unlockQuestion = document.getElementById('unlockQuestion');
            unlockQuestion.style.display = 'block';
            const buzzedPlayerInfo = document.getElementById('buzzedPlayerInfo');
            buzzedPlayerInfo.textContent = currentPlayer.name + ' is answering the question.';
            buzzedPlayerInfo.style.display = 'block';
        });
    </script>
</body>
</html>